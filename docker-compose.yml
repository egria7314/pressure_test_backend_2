version: '3'
services:
  db:
    image: postgres
  redis:
    image: "redis:alpine"
  celery:
    build: .
    privileged: true
    command: "/home/dqa/code/env/bin/celery -A pressure_test worker -l info -f %n-%i.log"
    volumes:
      - .:/home/dqa/data
    ports:
      - "5555:5555"
    environment:
      - NODE_ENV=${NODE_ENV}
    links:
      - db
      - redis
  web:
    build: .
    privileged: true
    entrypoint: /home/dqa/data/entrypoint.sh
    volumes:
      - .:/home/dqa/data
      - data:/home/dqa/data/pressure_test/log
      - celdata:/home/dqa/data/pressure_test
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=${NODE_ENV}
    depends_on:
      - db
    links:
      - redis
  filebeat:
    build: filebeat
    command: filebeat -e -strict.perms=false -E dock_host=${DOCK_HOST} -E elk_host=${ELK_HOST}
    volumes:
      - "./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro"
      - data:/mnt/log:ro
      - celdata:/mnt/celog:ro 
volumes:
  data:
    driver: "local"
  celdata:
    driver: "local"